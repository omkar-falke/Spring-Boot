drop procedure spldata.MM_ADPRC;
commit;

CREATE PROCEDURE SPLDATA.MM_ADPRC(IN LP_CMPCD varchar(2),IN LP_STRTP CHAR(2) ,IN LP_PORNO CHAR(8),IN  LP_YSTDT DATE, IN LP_PRCFL char(1)) 	LANGUAGE SQL SPECIFIC SPLDATA.MM_ADPRC NOT DETERMINISTIC MODIFIES SQL DATA CALLED ON NULL INPUT 
	P2 : 
	BEGIN 
	DECLARE L_PORVL DECIMAL ( 12 , 3 ) ; 	DECLARE L_BILVL DECIMAL ( 12 , 3 ) ;	
	DECLARE L_STKQT DECIMAL ( 12 , 3 ) ; 	DECLARE L_ACPQT DECIMAL ( 12 , 3 ) ; 
	DECLARE L_STSFL CHAR ( 1 ) ; 
	DECLARE L_GRNNO CHAR ( 8 ) ; 
	DECLARE L_MATCD CHAR ( 10 ) ; 	DECLARE L_ACPDT DATE ;   
	DECLARE END_TABLE INT DEFAULT 0 ; 	 
	DECLARE C_GRN CURSOR FOR SELECT GR_GRNNO,GR_MATCD,GR_ACPDT,isnull(GR_PORVL,0),isnull(GR_BILVL,0),isnull(GR_STSFL,''),
	isnull(GR_ACPQT,0),isnull(ST_STKQT,0) FROM SPLDATA.MM_GRMST,SPLDATA.MM_STMST WHERE  GR_CMPCD = LP_CMPCD and GR_STRTP = ST_STRTP 
	AND GR_MATCD = ST_MATCD AND isnull ( GR_STSFL , '' ) <> 'X' AND GR_STRTP = LP_STRTP AND GR_PORNO = LP_PORNO 
	ORDER BY GR_GRNNO,GR_MATCD ; 
		DECLARE CONTINUE HANDLER FOR NOT FOUND 
	SET END_TABLE = 1 ; 
	SET L_PORVL = 0 ; 	SET L_BILVL = 0 ; 	SET L_STSFL = ''; 
	SET L_STKQT = 0 ; 	SET L_ACPQT = 0 ; 
	SET L_MATCD = ' ' ; 
	OPEN C_GRN ; 
	FETCH C_GRN INTO L_GRNNO,L_MATCD ,L_ACPDT,L_PORVL,L_BILVL,L_STSFL,L_ACPQT,L_STKQT ; 
	WHILE END_TABLE = 0 DO    IF ((L_BILVL = 0 ) and (L_STSFL = '2' )) THEN     /* IF BILL PASSING IS NOT DONE, DO THE ADJUSTMENTS  */													   /* IF GRIN IS ACCEPTED, CUM RCT AND GR_PORVL IS CHANGED */	    IF (L_ACPDT >= LP_YSTDT) THEN 
		
			UPDATE SPLDATA.MM_GRMST SET (GR_PORVL,GR_EXCVL) = (SELECT  FLOAT(SUM(isnull(PO_ITVAL,0))) / FLOAT(SUM(isnull(PO_PORQT,0)/FLOAT(po_ucnvl))),
			FLOAT(SUM(isnull(PO_EXVAL,0))) / FLOAT(SUM(isnull(PO_PORQT,0)/FLOAT(po_ucnvl)))			FROM SPLDATA.MM_POMST WHERE PO_CMPCD = LP_CMPCD and PO_STRTP = GR_STRTP AND PO_PORNO = GR_PORNO AND 
			PO_MATCD = GR_matcd AND isnull(PO_PORQT,0) >0 AND isnull(PO_STSFL,'') <>'X' 
			GROUP BY PO_STRTP,PO_PORNO, PO_MATCD) WHERE GR_CMPCD = LP_CMPCD and GR_STRTP =LP_STRTP AND GR_GRNNO =L_GRNNO 
			AND GR_PORNO = LP_PORNO AND GR_MATCD =L_MATCD;

			UPDATE SPLDATA.MM_GRMST SET GR_PORVL = isnull(GR_PORVL,0)*isnull(L_ACPQT,0),GR_EXCVL =isnull(GR_EXCVL,0)*isnull(L_ACPQT,0)			WHERE GR_CMPCD = LP_CMPCD and GR_STRTP = LP_STRTP AND GR_GRNNO = L_GRNNO AND GR_MATCD = L_MATCD AND isnull(GR_STSFL,'') <>'X'; 
			UPDATE SPLDATA.MM_GRMST SET GR_GRNRT = isnull(GR_PORVL,0)/isnull(GR_ACPQT,0) WHERE 			GR_CMPCD = LP_CMPCD and GR_STRTP = LP_STRTP AND GR_GRNNO = L_GRNNO AND GR_MATCD = L_MATCD AND isnull(GR_STSFL,'') <>'X' AND isnull(GR_ACPQT,0) >0; 

			UPDATE SPLDATA.MM_STPRC SET STP_CRCVL =  isnull(STP_CRCVL,0)+(SELECT GR_PORVL-L_PORVL FROM SPLDATA.MM_GRMST WHERE GR_CMPCD = LP_CMPCD and GR_STRTP = STP_STRTP AND GR_STRTP = LP_STRTP AND GR_GRNNO =L_GRNNO AND GR_MATCD = STP_MATCD) 			where STP_CMPCD = LP_CMPCD and STP_STRTP = LP_STRTP and STP_MATCD = L_MATCD AND isnull(STP_CRCQT,0) >0;
			UPDATE SPLDATA.MM_STPRC SET STP_YCSVL =  isnull(STP_YCSVL,0)+(SELECT GR_PORVL-L_PORVL FROM SPLDATA.MM_GRMST WHERE GR_CMPCD = LP_CMPCD and GR_STRTP = STP_STRTP AND GR_STRTP = LP_STRTP AND GR_GRNNO =L_GRNNO AND GR_MATCD = STP_MATCD) 			where STP_CMPCD = LP_CMPCD and STP_STRTP = LP_STRTP and STP_MATCD = L_MATCD AND isnull(STP_YCSQT,0) >0;

			UPDATE SPLDATA.MM_STPRC SET STP_YCLRT = ROUND(isnull(STP_YCSVL,0)/isnull(STP_YCSQT,0),2)
			where STP_CMPCD = LP_CMPCD and STP_STRTP = LP_STRTP and STP_MATCD = L_MATCD AND isnull(STP_YCSQT,0) > 0;			UPDATE SPLDATA.MM_STPRC SET STP_WAVRT = ROUND(isnull(STP_CRCVL,0)/isnull(STP_CRCQT,0),2)
			where STP_CMPCD = LP_CMPCD and STP_STRTP = LP_STRTP and STP_MATCD = L_MATCD AND isnull(STP_CRCQT,0) >0;
		END IF;
		IF (L_ACPDT >= LP_YSTDT) and (LP_PRCFL = '0') THEN 
			UPDATE SPLDATA.MM_GRMST SET (GR_PORVL,GR_EXCVL) = (SELECT  FLOAT(SUM(isnull(PO_ITVAL,0))) / FLOAT(SUM(isnull(PO_PORQT,0)/FLOAT(po_ucnvl))),
			FLOAT(SUM(isnull(PO_EXVAL,0))) / FLOAT(SUM(isnull(PO_PORQT,0)/FLOAT(po_ucnvl)))			FROM SPLDATA.MM_POMST WHERE PO_CMPCD = LP_CMPCD and PO_STRTP = GR_STRTP AND PO_PORNO = GR_PORNO AND 
			PO_MATCD = GR_matcd AND isnull(PO_PORQT,0) >0 AND isnull(PO_STSFL,'') <>'X' 
			GROUP BY PO_STRTP,PO_PORNO, PO_MATCD) WHERE GR_CMPCD = LP_CMPCD and GR_STRTP =LP_STRTP AND GR_GRNNO =L_GRNNO 
			AND GR_PORNO = LP_PORNO AND GR_MATCD =L_MATCD;

			UPDATE SPLDATA.MM_GRMST SET GR_PORVL = isnull(GR_PORVL,0)*isnull(L_ACPQT,0),GR_EXCVL =isnull(GR_EXCVL,0)*isnull(L_ACPQT,0)			WHERE GR_CMPCD = LP_CMPCD and GR_STRTP = LP_STRTP AND GR_GRNNO = L_GRNNO AND GR_MATCD = L_MATCD AND isnull(GR_STSFL,'') <>'X'; 
			UPDATE SPLDATA.MM_GRMST SET GR_GRNRT = isnull(GR_PORVL,0)/isnull(GR_ACPQT,0) WHERE 			GR_CMPCD = LP_CMPCD and GR_STRTP = LP_STRTP AND GR_GRNNO = L_GRNNO AND GR_MATCD = L_MATCD AND isnull(GR_STSFL,'') <>'X' AND isnull(GR_ACPQT,0) >0; 

			UPDATE SPLDATA.MM_STPRC SET STP_CRCVL =  isnull(STP_CRCVL,0)+(SELECT GR_PORVL-L_PORVL FROM SPLDATA.MM_GRMST WHERE GR_CMPCD = LP_CMPCD and GR_STRTP = STP_STRTP AND GR_STRTP = LP_STRTP AND GR_GRNNO =L_GRNNO AND GR_MATCD = STP_MATCD) 			where STP_CMPCD = LP_CMPCD and STP_STRTP = LP_STRTP and STP_MATCD = L_MATCD AND isnull(STP_CRCQT,0) >0;
			UPDATE SPLDATA.MM_STPRC SET STP_YCSVL =  isnull(STP_YCSVL,0)+(SELECT GR_PORVL-L_PORVL FROM SPLDATA.MM_GRMST WHERE GR_CMPCD = LP_CMPCD and GR_STRTP = STP_STRTP AND GR_STRTP = LP_STRTP AND GR_GRNNO =L_GRNNO AND GR_MATCD = STP_MATCD) 			where STP_CMPCD = LP_CMPCD and STP_STRTP = LP_STRTP and STP_MATCD = L_MATCD AND isnull(STP_YCSQT,0) >0;

			UPDATE SPLDATA.MM_STPRC SET STP_YCLRT = ROUND(isnull(STP_YCSVL,0)/isnull(STP_YCSQT,0),2)
			where STP_CMPCD = LP_CMPCD and STP_STRTP = LP_STRTP and STP_MATCD = L_MATCD AND isnull(STP_YCSQT,0) > 0;			UPDATE SPLDATA.MM_STPRC SET STP_WAVRT = ROUND(isnull(STP_CRCVL,0)/isnull(STP_CRCQT,0),2)
			where STP_CMPCD = LP_CMPCD and STP_STRTP = LP_STRTP and STP_MATCD = L_MATCD AND isnull(STP_CRCQT,0) >0;				END IF;
       END IF;
    
    FETCH C_GRN INTO L_GRNNO,L_MATCD ,L_ACPDT,L_PORVL,L_BILVL,L_STSFL,L_ACPQT,L_STKQT ;  
	END WHILE ; 
	CLOSE C_GRN ; 
	COMMIT ; 
	END P2  ; 
  commit;

