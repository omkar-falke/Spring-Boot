drop procedure SPLDATA.mm_isprc;
commit;


create procedure SPLDATA.mm_isprc(IN LP_CMPCD char(2),IN LP_STRTP CHAR(2),IN LP_INDNO char(8),IN LP_LUSBY CHAR(3),IN LP_AUTBY CHAR(3),IN LP_DPTCD CHAR(3),IN LP_ISSNO CHAR(8)) language sql modifies sql data
P2:
begin
declare L_MMSBS char(6);

declare L_STRTP char(2);
declare L_MATCD char(10);
declare L_STKQT decimal(12,3);
declare L_STKIN  decimal(12,3);
declare L_STKIP  decimal(12,3);
declare L_STKOR  decimal(12,3);
declare L_RORLV  decimal(12,3);
declare L_RORQT  decimal(12,3);
declare L_COUNT  decimal(4,0);
declare L_LEDTM  decimal(4,0);
declare L_ILDTM  decimal(4,0);
declare L_ELDTM  decimal(4,0);
declare L_TCFFL  CHAR(1);
declare L_INSFL  CHAR(1);
declare END_TABLE int default 0; 

declare C_ISS CURSOR FOR SELECT DISTINCT IS_MMSBS,IS_STRTP,IS_MATCD,ST_STKQT,ST_STKIN,ST_STKIP,ST_STKOR,ST_RORLV,ST_RORQT,isnull(CT_ILDTM,0) L_ILDTM,isnull(CT_ELDTM,0)L_ELDTM,isnull(CT_TCFFL,''),isnull(CT_INSFL,'') FROM SPLDATA.MM_ISMST, SPLDATA.MM_STMST,SPLDATA.CO_CTMST WHERE IS_CMPCD = LP_CMPCD and IS_CMPCD = ST_CMPCD and IS_STRTP = ST_STRTP AND IS_MATCD = ST_MATCD AND IS_MATCD = CT_MATCD AND IS_STRTP = LP_STRTP AND IS_ISSNO = LP_ISSNO AND isnull(ST_STKQT,0)+isnull(ST_STKIN,0)+isnull(ST_STKOR,0) < isnull(ST_RORLV,0) AND isnull(ST_STKFL,'') ='Y' and isnull(ct_stsfl,'') <> '9';
declare continue handler for not found 
set END_TABLE  =1;
SET L_COUNT =0;
open C_ISS;
fetch C_ISS INTO L_MMSBS,L_STRTP,L_MATCD,L_STKQT,L_STKIN,L_STKIP,L_STKOR,L_RORLV,L_RORQT,L_ILDTM,L_ELDTM,L_TCFFL,L_INSFL ; 
while END_TABLE =0 DO
SET L_COUNT = L_COUNT +1;
set L_LEDTM = L_ILDTM +L_ELDTM;
INSERT INTO SPLDATA.MM_INMST(IN_CMPCD,IN_MMSBS,IN_STRTP,IN_INDTP,IN_INDNO,IN_AMDNO,IN_INDDT,IN_URGTG,IN_DPTCD,IN_PREBY,IN_AUTBY,IN_PREDT,IN_AUTDT,IN_MATCD,IN_INDQT,IN_AUTQT,IN_PORBY,IN_REQDT,IN_EXPDT,IN_TCFFL,IN_INSFL,IN_TRNFL,IN_STSFL,IN_LUSBY,IN_LUPDT)
VALUES(LP_CMPCD,L_MMSBS,L_STRTP,'01',LP_INDNO,'00',getdate(),'N',LP_DPTCD,LP_LUSBY,LP_AUTBY,CURRENT_TIMESTAMP,CURRENT_TIMESTAMP,L_MATCD,L_RORQT,L_RORQT,CONVERT(varchar,DAY(getdate())+L_ILDTM,101),CONVERT(varchar,DAY(getdate())+L_LEDTM,101),CONVERT(varchar,DAY(getdate())+L_LEDTM,101),L_TCFFL,L_INSFL,'0','4',LP_LUSBY,getdate()); 
update SPLDATA.MM_STMST set ST_TRNFL ='0',ST_LUPDT = getdate(), ST_STKIN =  isnull(ST_STKIN,0) + isnull(L_RORQT,0) 
 where ST_CMPCD = LP_CMPCD and ST_STRTP = L_STRTP and ST_MATCD = L_MATCD;

fetch C_ISS INTO L_MMSBS,L_STRTP,L_MATCD,L_STKQT,L_STKIN,L_STKIP,L_STKOR,L_RORLV,L_RORQT,L_ILDTM,L_ELDTM,L_TCFFL,L_INSFL ; 
END WHILE; 
IF L_COUNT > 0 THEN 
INSERT INTO SPLDATA.MM_RMMST(RM_CMPCD,RM_MMSBS,RM_STRTP,RM_TRNTP,RM_REMTP,RM_DOCTP,RM_DOCNO,RM_REMDS,RM_TRNFL,RM_LUSBY,RM_LUPDT) VALUES(LP_CMPCD,L_MMSBS,L_STRTP,'IN','IND','IN',LP_INDNO,'FOR REPLENISHMENT OF STOCK CONTROLLED ITEM/s.','0',LP_LUSBY,getdate()); 
END IF;
CLOSE C_ISS; 
COMMIT; 
END P2; 

commit;
