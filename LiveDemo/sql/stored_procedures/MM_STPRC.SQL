drop procedure SPLDATA.mm_stprc;
commit;


create procedure SPLDATA.mm_stprc(IN LP_CMPCD char(2),IN LP_STRTP CHAR(2),IN LP_INDNO char(8),IN LP_LUSBY CHAR(3),IN LP_AUTBY CHAR(3),IN LP_DPTCD CHAR(3)) language sql modifies sql data

P2:

begin

declare L_MMSBS char(6);



declare L_STRTP char(2);

declare L_MATCD char(10);

declare L_STKQT decimal(12,3);

declare L_STKIN  decimal(12,3);

declare L_STKIP  decimal(12,3);

declare L_STKOR  decimal(12,3);

declare L_RORLV  decimal(12,3);

declare L_RORQT  decimal(12,3);

declare L_COUNT  decimal(3,0);

declare L_ILDTM  decimal(3,0);

declare L_ELDTM  decimal(3,0);

declare END_TABLE int default 0; 

declare C_STK CURSOR FOR SELECT ST_MMSBS,ST_STRTP,ST_MATCD,ST_STKQT,ST_STKIN,ST_STKIP,ST_STKOR,ST_RORLV,ST_RORQT,CT_ILDTM,CT_ELDTM FROM SPLDATA.MM_STMST,SPLDATA.CO_CTMST WHERE ST_CMPCD = LP_CMPCD and ST_MATCD = CT_MATCD AND CT_STSFL <>'9' AND isnull(ST_STKQT,0)+isnull(ST_STKIN,0)+isnull(ST_STKOR,0) < isnull(ST_RORLV,0) AND ST_STKFL ='Y' ORDER BY ST_STRTP,ST_MATCD; 

declare continue handler for not found 

set END_TABLE  =1;

SET L_COUNT = 0;

open C_STK;

fetch C_STK INTO L_MMSBS,L_STRTP,L_MATCD,L_STKQT,L_STKIN,L_STKIP,L_STKOR,L_RORLV,L_RORQT,L_ILDTM,L_ELDTM ; 

while END_TABLE =0 DO

 SET L_COUNT = L_COUNT+1; 

 IF (L_ILDTM = 0) THEN 

    SET L_ILDTM = 21;

 END IF;   

 IF (L_ELDTM = 0) THEN 

    SET L_ELDTM = 30;

 END IF;   

INSERT INTO SPLDATA.MM_INMST(IN_CMPCD,IN_MMSBS,IN_STRTP,IN_INDTP,IN_INDNO,IN_AMDNO,IN_INDDT,IN_URGTG,IN_DPTCD,IN_PREBY,IN_AUTBY,IN_PREDT,IN_AUTDT,IN_MATCD,IN_INDQT,IN_AUTQT,IN_TRNFL,IN_STSFL,IN_LUSBY,IN_LUPDT,IN_PORBY,IN_REQDT,IN_EXPDT)

VALUES(LP_CMPCD,L_MMSBS,L_STRTP,'01',LP_INDNO,'00',getdate(),'N',LP_DPTCD,LP_LUSBY,LP_AUTBY,CURRENT_TIMESTAMP,CURRENT_TIMESTAMP,L_MATCD,L_RORQT,L_RORQT,'0','4',LP_LUSBY,getdate(),CONVERT(varchar,DAY(getdate())+L_ILDTM,101),CONVERT(varchar,DAY(getdate())+L_ILDTM+L_ELDTM,101),CONVERT(varchar,DAY(getdate())+L_ILDTM+L_ELDTM,101)); 

update SPLDATA.MM_STMST set ST_TRNFL ='0',ST_LUPDT = getdate(), ST_STKIN =  isnull(ST_STKIN,0) + isnull(L_RORQT,0) 

 where ST_CMPCD = LP_CMPCD and ST_STRTP = L_STRTP and ST_MATCD = L_MATCD;



fetch C_STK INTO L_MMSBS,L_STRTP,L_MATCD,L_STKQT,L_STKIN,L_STKIP,L_STKOR,L_RORLV,L_RORQT,L_ILDTM,L_ELDTM ; 

END WHILE; 

IF L_COUNT > 0 THEN

INSERT INTO SPLDATA.MM_RMMST(RM_CMPCD,RM_MMSBS,RM_STRTP,RM_TRNTP,RM_REMTP,RM_DOCTP,RM_DOCNO,RM_REMDS,RM_TRNFL,RM_LUSBY,RM_LUPDT)

VALUES(LP_CMPCD,L_MMSBS,L_STRTP,'IN','IND','IN',LP_INDNO,'AUTO GENERATED','0',LP_LUSBY,getdate()); 

END IF;

CLOSE C_STK; 

COMMIT; 

END P2; 

commit;


